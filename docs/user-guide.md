# 用户指南

本指南介绍如何使用 Markdown Viewer 的预览与内置编辑器能力，包括文件树式“另存为”、快捷键以及并发冲突的“覆盖保存”。

## 启动与访问

- 启动（开发）：`npm start`
- 启动（全局CLI，本地安装方案B）：
  ```bash
  mdviewer                 # 默认端口 3000，工作目录为当前目录
  mdviewer --port 4000    # 指定端口
  mdviewer --dir ~/notes  # 指定工作目录（读取该目录下的 Markdown 文档）
  mdviewer --port 4000 --dir /path/to/markdowns
  ```
- 访问：打开浏览器进入 `http://localhost:<端口>`（默认 3000）
- WebSocket 端口：= HTTP 端口 + 5080；例如 HTTP 4000 则 WS 为 9080

## 界面说明

- 左侧：文件树（仅显示 Markdown 文件），支持展开/收起
- 中部：文档大纲（标题导航），可收起；移动端收起后保留把手可再次展开
- 右侧：内容预览，支持 Mermaid/Prism 等渲染
- 顶部：面包屑与主题切换按钮

## 预览页操作

- 编辑当前文件：点击右上角“✏️ 编辑文件”，跳转到编辑器页面
- 刷新内容：点击“🔄”按钮重新加载当前文件
- 主题切换：点击“☀️/🌙”等图标，循环切换主题（偏好持久化）

## 内置编辑器

- 入口：`/editor.html?file=<相对路径>&return=<返回页>`
- 工具栏：保存、另存为、返回、预览开关、加粗/斜体、H1–H6
- 编辑区：左侧文本框输入 Markdown
- 预览区：右侧实时渲染；关闭预览时不渲染，状态持久化到 localStorage

### 快捷键

- Cmd/Ctrl+S：保存
- Cmd/Ctrl+B：加粗（包裹选区为 `**`）
- Cmd/Ctrl+I：斜体（包裹选区为 `*`）
- Cmd/Ctrl+1..6：在行首插入 `#` 至 `######`

### 保存

- 正常保存：成功返回 `lastModified`，状态栏显示“已保存”
- 并发冲突：若文件在外部被修改，保存会返回 409；编辑器会弹出“并发冲突”对话框
- 覆盖保存：点击“覆盖保存”后，前端携带 `override: true` 再次提交，服务端跳过并发校验并保存成功

### 另存为（文件树式）

- 打开弹窗：点击“📝 另存为”
- 选择目录：在弹窗左侧的文件树中选择目标目录（或选中文件自动带出目录与文件名）
- 输入文件名：右侧输入框填写文件名（仅支持 `.md/.markdown/.mdown/.mkd/.mkdn`）
- 保存成功：页面地址更新为新文件路径，标题显示“编辑：<新路径>”，继续编辑与保存

### 返回预览页

- 点击“⟵ 返回”回到原预览页
- 若存在未保存更改，会提示确认离开

## 支持的图表与高亮

- Mermaid：流程图、时序图、甘特图、类图等
- Prism：多语言代码高亮，自动按 `language-xxx` 识别

## 故障排查

- 保存报 409：说明外部已修改，使用弹窗“覆盖保存”或先刷新文件再编辑
- 保存报 404：请确认本地服务已重启，且访问地址是 `http://localhost:3000`
- 另存为失败：检查文件名扩展是否为 Markdown；确认目录在工作区内
- 流程图不渲染：检查 CDN 可访问性与语法；控制台无报错

## 限制与安全

- 仅允许工作区内 Markdown 文件读写，防止越权与符号链接逃逸
- 同源校验：修改操作需来自同源页面（Origin/Referer 包含 host）
- 请求体上限：10MB

如需进一步帮助，请查看控制台日志与 Network 请求详情，或联系维护者。